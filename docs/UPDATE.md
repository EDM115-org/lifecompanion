# Publishing updates (official devs)

This page contains general information on LifeCompanion app and side projects developpements.

# Environments

There is three configured environment in LifeCompanion. Env are a good way to test and deploy updates before production.

| ID          | Description                                                     |
|-------------| --------------------------------------------------------------- |
| **local**   | developper local env on his own machine                         |
| **dev**     | staging environment to test on production configuration         |
| **prod**    | production configuration                                        |

Each of these environments has its own configuration to be runned and to be deployed on. It is possible to create a full
running architecture for each env (update server, launcher, installer, app)

When calling specific Gradle script to deploy updates (see [Creating updates](#user-content-creating-updates)), you can
inject env with `-Penv=prod` argument to Gradle commands. Default environment is always `local`

# Branches and tags organization on GitHub

LifeCompanion uses branches and tags to organize its repo.

| Name            | Description                                                                                      |
| :-------------- | ------------------------------------------------------------------------------------------------ |
| **main**        | main and clean source branch, last published version are on this branch                          |
| **develop**     | current development branch, all fixes and things feature merges are on this branch               |
| **feature/\***  | individual branches created for specific feature                                                 |

Tags are used for releases, tags are created are composed of : project, sub-project, version, env.

Example : `lifecompanion/lc-app/1.0.0-prod` describe LifeCompanion application version 1.0.0 in production env.

Tags are detailled in [Creating updates](#user-content-creating-updates) section (with naming strategy).

## Updates build env

To build LifeCompanion updates (on app, installer, launcher, server...) you should have configured various properties.

### Base configuration

Most of the gradle properties are already configured in *lifecompanion/gradle.properties*

The properties that can be changed depending on your local machine are :

- **innosetup.path** : path to InnoSetup installation
- **lc.build.resources.directory** : path to the software resource directory (when publishing updates) - this path can
  be absolute or relative to *lifecompanion/lc-app*

Other properties are configured for default environments, but can be changed

### Target environment configuration

Target environments are configured in **env** directory. When you first run LifeCompanion, it will automatically
create **env/.env.local** file from **.env.example**.

If you want to define other environment, you can create configuration file in **env** directory, for example **
env/.env.prod** file.

An .env file contains following properties :

- **lifecompanion.framework.server.url** :path to update server to download/upload updates
- **lifecompanion.framework.server.login** : login to connect to update server and upload update
- **lifecompanion.framework.server.password** : password to connect to update server and upload update
- **lifecompanion.app.server.url** : path to LifeCompanion website
- **lifecompanion.app.server.query.parameters** : useful to add a query parameter to each app server request (can be
  left empty)
- **lifecompanion.app.server.public_key** : public key for LifeCompanion website API
- **lifecompanion.build.resources.s3.access.key** : AWS access key for build resource S3
- **lifecompanion.build.resources.s3.secret** : AWS secret for build resource S3

### Env var configuration

#### On dev env

- **HEROKU_API_KEY** : if you need to publish server builds (Heroku API key should be generated on your account)
- **LIFECOMPANION_JDK_JFX_PATH** : will contains platforms JDK and JavaFX binaries (to publish updates). This variable
  is optionnal, if not specified, default path is **~/.lifecompanion-jdk-jfx**

#### On server env (you may need to create these on your dev. env when needed)

- **DATABASE_URL** : (generated by heroku ) database URL (example : *postgres://username:password@host:
  port/database_name*) or create by dev. on local machine
- **JWT_SECRET** : JWT secret to generate auth. tokens
- **LC_PLATFORM_API_TOKEN** : API token to call stats API
- **LC_PLATFORM_URL** : URL for stats API (example *https://lifecompanionaac.org*)
- **LC_PLATFORM_URL_PASSWORD** : (optionnal) query parameters to append to LC_PLATFORM_URL (example *
  ?app_password=password*)
- **AMAZON_S3_BUCKET** : Amazon S3 bucket
- **AMAZON_S3_ACCES_KEY** : Amazon S3 access key
- **AMAZON_S3_SECRET** : Amazon S3 secret
- **AMAZON_S3_REGION** : Amazon S3 region (example *eu-west-3*)

## Creating updates

**This part is meant to be read by official developpers and is not needed by anyone who just want to contribute.**

**Most of this logic in implemented with [GitHub actions on official repository](../.github/workflows) so these tasks
are not run on developer env.**

All task bellow are depending on a destination environment and should be run with `-Penv=dev` or `-Penv=prod` argument (
on Gradle task) if you want to target other env. than local. Content of the task should also be adapted to destination
env (e.g. tags)

Creating updates depends on custom Gradle task and plugin, all located in *lifecompanion/buildSrc*

### Create LifeCompanion update

*When file are too big for direct upload during update (e.g. image zips, file > 100 MB), file should be uploaded
manually in file storage and then linked with `PRESET_STORAGE_IDS` in `PublishApplicationTask`*

1. Check `lifecompanion.app.version` in *lifecompanion/gradle.properties*
1. Check `visibility` in *lifecompanion/gradle.properties*, it can be PREVIEW, PUBLISHED or HIDDEN
1. Check path for file to unzip : `TO_UNZIP_PATH` in *PublishApplicationTask*
1. Check path for file with manual storage : `PRESET_STORAGE_IDS` in *PublishApplicationTask*
1. Commit and tag repo with **lifecompanion/lc-app/X.X.X-prod**
1. Run `gradlew :lc-app:publishApplication -Penv=prod` in **lifecompanion**

### Create LifeCompanion installer update

*Installer updates should be generated on Windows as InnoSetup is used to generated the installer exe*

1. Check `lifecompanion.installer.version` in *lifecompanion/gradle.properties*
1. Check `visibility` in *lifecompanion/gradle.properties*, it can be PREVIEW, PUBLISHED or HIDDEN
1. Commit and tag repo with **lifecompanion/lc-installer/X.X.X-prod**
1. Run `gradlew :lc-installer:publishInstaller -Penv=prod` in **lifecompanion**

**Note on Windows security alert** : when publishing new server updates, you should think about reporting the installer as safe for Windows. To do so, download the new installer with Edge and signal it as trusted site.

### Deploy LifeCompanion server update in production

#### Prepare a LifeCompanion server

1. Create Heroku app and Amazon S3 storage bucket
1. Add postgres on Heroku
1. Configure Heroku app with env var (see env var part)
1. Generate your login and password hash (for password hash,
   use `System.out.println(BCrypt.hashpw("password",BCrypt.gensalt()));`)

```
INSERT INTO app_user(id,login,password,role) VALUES ('A_RANDOM_UUID','MY_LOGIN','MY_PASSWORD_HASHED','ADMIN');
INSERT INTO application(id) VALUES ('lifecompanion');
```

*Example for admin/password (you can use that for your local env)*

```
INSERT INTO app_user(id,login,password,role) VALUES ('dbb0fd9b-bc96-4395-ab4b-f3b583c5fddf','admin','$2a$10$lxaKVIrNPOm8vg7YODdVBuBnMUDSIPAsrEP6cUEei0hXN0romnSUW','ADMIN');
INSERT INTO application(id) VALUES ('lifecompanion');
```

#### Create LifeCompanion server update

*Note on env : for the specific case of LifeCompanion update server, note that we always publish in dev as the dev
application is then promoted to prod on Heroku*

1. Update server version in build.gradle if needed
1. Check your scripts in **src/main/resources/sql/migrations** and add them to `DataSource.MIGRATIONS_SCRIPT_NAMES`
1. Check that you have the correct **HEROKU_API_KEY** env variable
1. Commit and tag repo with **lifecompanion-framework/lc-framework-server/X.X.X**
1. Run `gradlew :lc-framework-server:publishServerUpdate -Penv=dev` in **lifecompanion-framework**
1. If you have migration scripts, you can check them in Heroku log

---

# Solving problems

#### Delete a git tag

1. Delete locally : `git tag --delete lifecompanion/lc-installer/1.5.4-prod`
1. Delete if pushed : `git push --delete origin lifecompanion/lc-installer/1.5.4-prod`


